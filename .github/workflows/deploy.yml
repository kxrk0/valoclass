name: Deploy ValoClass to VPS

# Bu iÅŸ akÄ±ÅŸÄ± ne zaman Ã§alÄ±ÅŸacak?
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    # Bu iÅŸlerin Ã§alÄ±ÅŸacaÄŸÄ± sanal makine
    runs-on: ubuntu-latest

    steps:
      # 1. AdÄ±m: Kodu GitHub Actions makinesine indir
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. AdÄ±m: Node.js kurulumu
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Frontend iÃ§in temizleme (sadece node_modules)
      - name: Temiz node_modules (Frontend)
        run: |
          rm -rf node_modules
          echo "Frontend node_modules klasÃ¶rÃ¼ silindi."

      # Frontend baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± kur
      - name: Install dependencies (frontend)
        run: npm ci

      # Frontend build (Next.js)
      - name: Build Frontend
        run: npm run build

      # Frontend arÅŸivleme (.next/cache hariÃ§, backend klasÃ¶rÃ¼ hariÃ§)
      - name: Archive frontend
        run: |
          tar --exclude='backend' --exclude='.git' --exclude='node_modules' --exclude='.next/cache' -czvf frontend.tar.gz . || {
            code=$?
            echo "UyarÄ±: tar arÅŸivleme sÄ±rasÄ±nda dosya deÄŸiÅŸti (kod: $code), bu genellikle Ã¶nemsizdir.";
            exit 0;
          }

      # Backend iÃ§in temizleme (sadece node_modules)
      - name: Temiz node_modules (Backend)
        run: |
          cd backend
          rm -rf node_modules
          echo "Backend node_modules klasÃ¶rÃ¼ silindi."
          cd ..

      # Backend baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± kur (TypeScript runtime kullanacaÄŸÄ±z)
      - name: Install dependencies (backend)
        run: |
          cd backend
          npm ci --omit=dev
          cd ..

      # Backend arÅŸivleme
      - name: Archive backend
        run: tar --exclude='node_modules' -czvf backend.tar.gz -C backend .

      # ArÅŸivleri VPS'e kopyala
      - name: Copy archives to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          source: "frontend.tar.gz,backend.tar.gz"
          target: "/root"
          strip_components: 0

      # VPS'te deploy iÅŸlemleri
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            set -e
            
            # Ana dizini oluÅŸtur
            mkdir -p /root/valoclass
            
            # Eski dosyalarÄ± backup al
            if [ -d "/root/valoclass" ]; then
              echo "ğŸ“¦ Mevcut dosyalar backup alÄ±nÄ±yor..."
              cp -r /root/valoclass /root/valoclass-backup-$(date +%Y%m%d-%H%M%S) || true
            fi

            # Frontend arÅŸivini Ã§Ä±kar
            echo "ğŸš€ Frontend deploy ediliyor..."
            tar -xzvf /root/frontend.tar.gz -C /root/valoclass

            # Backend dizini oluÅŸtur ve arÅŸivi Ã§Ä±kar
            echo "âš¡ Backend deploy ediliyor..."
            mkdir -p /root/valoclass/backend
            tar -xzvf /root/backend.tar.gz -C /root/valoclass/backend

            # Frontend baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± kur
            echo "ğŸ“¦ Frontend baÄŸÄ±mlÄ±lÄ±klarÄ± kuruluyor..."
            cd /root/valoclass
            npm ci --omit=dev

            # Backend baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± kur (sadece production)
            echo "ğŸ“¦ Backend production baÄŸÄ±mlÄ±lÄ±klarÄ± kuruluyor..."
            cd /root/valoclass/backend
            npm ci --omit=dev

            # Prisma generate (eÄŸer varsa)
            echo "ğŸ—„ï¸  VeritabanÄ± ÅŸemasÄ± generate ediliyor..."
            npx prisma generate --schema=./prisma/schema.prisma || echo "Prisma generate skipped"
            
            # VeritabanÄ± migrasyonlarÄ± (production iÃ§in)
            echo "ğŸ—„ï¸  VeritabanÄ± migrasyonlarÄ± uygulanÄ±yor..."
            npx prisma db push --schema=./prisma/schema.prisma || echo "Database push skipped"

            # PM2 ile servisleri yeniden baÅŸlat
            echo "ğŸ”„ PM2 servisleri yeniden baÅŸlatÄ±lÄ±yor..."
            
            # Frontend servisi (Next.js)
            echo "ğŸ–¥ï¸  Frontend servisi baÅŸlatÄ±lÄ±yor..."
            pm2 stop valoclass-frontend || true
            pm2 delete valoclass-frontend || true
            cd /root/valoclass
            pm2 start npm --name "valoclass-frontend" -- start
            
            # Backend servisi (Express.js)
            echo "âš™ï¸  Backend servisi baÅŸlatÄ±lÄ±yor..."
            pm2 stop valoclass-backend || true
            pm2 delete valoclass-backend || true
            cd /root/valoclass/backend
            pm2 start npm --name "valoclass-backend" -- start

            # Servisleri kaydet
            pm2 save
            pm2 status

            # Health check
            echo "ğŸ¥ Sistem durumu kontrol ediliyor..."
            sleep 5
            
            # Frontend health check (Next.js Port 3000)
            echo "ğŸ” Frontend health check..."
            curl -I http://localhost:3000 && echo "âœ… Frontend eriÅŸilebilir" || echo "âŒ Frontend eriÅŸilemiyor"
            
            # Backend health check (Express.js Port 8000)
            echo "ğŸ” Backend health check..."
            curl -I http://localhost:8000/api || curl -I http://localhost:8000 && echo "âœ… Backend eriÅŸilebilir" || echo "âŒ Backend eriÅŸilemiyor"
            
            # Caddy proxy health check
            echo "ğŸ” Caddy proxy health check..."
            curl -I http://localhost:80 && echo "âœ… Caddy proxy Ã§alÄ±ÅŸÄ±yor" || echo "âŒ Caddy proxy Ã§alÄ±ÅŸmÄ±yor"
            
            # System status endpoint
            echo "ğŸ” System status endpoint..."
            curl -s http://localhost:8080/status && echo "" || echo "âŒ Status endpoint eriÅŸilemiyor"

            # Cleanup temp files
            rm -f /root/frontend.tar.gz /root/backend.tar.gz

            echo "ğŸ‰ ValoClass deploy tamamlandÄ±!"

      # Temizlik
      - name: Cleanup
        run: rm -f frontend.tar.gz backend.tar.gz
